Sub DatenZuweisung()
    Dim wsRohdaten As Worksheet, wsZuweisung As Worksheet, wsKategorien As Worksheet
    Dim ZielWs As Worksheet
    Dim lastRowRoh As Long, lastRowZuweisung As Long, lastRowKategorien As Long, zielRow As Long
    Dim i As Long, j As Long, k As Long, headerCol As Long
    Dim Schluessel As String, ZielBlattName As String
    Dim Datum As Date, Gestern As Date
    Dim Kategorie As String, SuchText As String
    Dim Kalenderwoche As String

    ' Arbeitsblätter zuweisen
    Set wsRohdaten = ThisWorkbook.Worksheets("Rohdaten")
    Set wsZuweisung = ThisWorkbook.Worksheets("Zuweisung")
    Set wsKategorien = ThisWorkbook.Worksheets("Kategorien")

    ' Letzte Zeile in "Rohdaten", "Zuweisung" und "Kategorien" finden
    lastRowRoh = wsRohdaten.Cells(wsRohdaten.Rows.Count, "A").End(xlUp).Row
    lastRowZuweisung = wsZuweisung.Cells(wsZuweisung.Rows.Count, "B").End(xlUp).Row
    lastRowKategorien = wsKategorien.Cells(wsKategorien.Rows.Count, "A").End(xlUp).Row

    Debug.Print "Letzte Zeile in Rohdaten: " & lastRowRoh
    Debug.Print "Letzte Zeile in Zuweisung: " & lastRowZuweisung
    Debug.Print "Letzte Zeile in Kategorien: " & lastRowKategorien

    ' Durch die Schlüssel in "Zuweisung" iterieren
    For i = 2 To lastRowZuweisung ' Starte bei 2, um Kopfzeile zu überspringen
        Schluessel = wsZuweisung.Cells(i, "B").Value
        ZielBlattName = wsZuweisung.Cells(i, "C").Value

        Debug.Print "Verarbeite Schlüssel: " & Schluessel & ", Zielblatt: " & ZielBlattName

        ' Ziel-Arbeitsblatt prüfen
        On Error Resume Next
        Set ZielWs = ThisWorkbook.Worksheets(ZielBlattName)
        On Error GoTo 0

        If Not ZielWs Is Nothing Then
            ' Daten aus "Rohdaten" finden
            For j = 2 To lastRowRoh
                If wsRohdaten.Cells(j, "A").Value = Schluessel Then
                    ' Kalenderwoche berechnen
                    Datum = wsRohdaten.Cells(j, "D").Value
                    Kalenderwoche = "KW " & Format(Application.WeekNum(Datum, vbMonday), "00")

                    ' Zielzelle für Kalenderwoche finden (nur exakt "KW xx" in Spalte A)
                    Dim startCell As Range, targetRow As Long
                    Set startCell = ZielWs.Columns("A").Find(What:=Kalenderwoche, LookIn:=xlFormulas, LookAt:=xlWhole)
                    If Not startCell Is Nothing Then
                        targetRow = startCell.Row + 9 ' 9 Zeilen unter der gefundenen Zelle beginnen

                        ' Prüfen, ob die Zellen leer sind und Daten einfügen
                        Do While ZielWs.Cells(targetRow, "A").Value <> ""
                            targetRow = targetRow + 1
                        Loop

                        Debug.Print "Füge Daten ein in Zeile: " & targetRow & " des Blatts: " & ZielBlattName

                        ' Text in Zielarbeitsblatt von C12 bis Q12 durchsuchen und Werte aus Rohdaten holen
                        For headerCol = 3 To 17 ' Spalten C bis Q (3 bis 17)
                            SuchText = "Frage: " & ZielWs.Cells(12, headerCol).Value

                            ' Überschrift in Zeile 1 von "Rohdaten" suchen
                            Dim rohCol As Long
                            rohCol = 0
                            For k = 1 To wsRohdaten.Cells(1, wsRohdaten.Columns.Count).End(xlToLeft).Column
                                If wsRohdaten.Cells(1, k).Value = SuchText Then
                                    rohCol = k
                                    Exit For
                                End If
                            Next k

                            If rohCol > 0 Then
                                Dim rohWert As String
                                rohWert = wsRohdaten.Cells(j, rohCol).Value

                                ' Überschreiben der Werte
                                Select Case rohWert
                                    Case "Ja"
                                        ZielWs.Cells(targetRow, headerCol).Value = "j"
                                    Case "Nein"
                                        ZielWs.Cells(targetRow, headerCol).Value = "n"
                                    Case "Teilweise"
                                        ZielWs.Cells(targetRow, headerCol).Value = "t"
                                    Case "N/A"
                                        ZielWs.Cells(targetRow, headerCol).Value = ""
                                    Case Else
                                        ZielWs.Cells(targetRow, headerCol).Value = rohWert
                                End Select
                            Else
                                Debug.Print "Überschrift " & SuchText & " nicht in Rohdaten gefunden."
                            End If
                        Next headerCol

                        ' Daten übertragen
                        ZielWs.Cells(targetRow, "A").Value = wsRohdaten.Cells(j, "B").Value ' Vorgangsnummer
                        ZielWs.Cells(targetRow, "B").Value = Kategorie ' Angepasste Kategorie aus "Kategorien"
                        ZielWs.Cells(targetRow, "U").Value = Gestern ' Datum von Gestern oder Freitag
                        ZielWs.Cells(targetRow, "V").Value = wsRohdaten.Cells(j, "D").Value ' Datum
                        ZielWs.Cells(targetRow, "W").Value = wsRohdaten.Cells(j, "E").Value ' Bemerkung
                    Else
                        Debug.Print "Kalenderwoche " & Kalenderwoche & " nicht in Zielblatt gefunden."
                    End If
                End If
            Next j
        Else
            Debug.Print "Das Arbeitsblatt " & ZielBlattName & " existiert nicht."
        End If
    Next i

    Debug.Print "Datenübertragung abgeschlossen!"
    MsgBox "Datenübertragung abgeschlossen!", vbInformation
End Sub
