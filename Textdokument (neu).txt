Sub DatenZuweisung()
    Dim wsRohdaten As Worksheet, wsZuweisung As Worksheet, wsKategorien As Worksheet
    Dim ZielWs As Worksheet
    Dim lastRowRoh As Long, lastRowZuweisung As Long, lastRowKategorien As Long, zielRow As Long
    Dim i As Long, j As Long, k As Long, headerCol As Long
    Dim Schluessel As String, ZielBlattName As String
    Dim Datum As Date, Gestern As Date
    Dim Kategorie As String, SuchText As String

    ' Arbeitsblätter zuweisen
    Set wsRohdaten = ThisWorkbook.Worksheets("Rohdaten")
    Set wsZuweisung = ThisWorkbook.Worksheets("Zuweisung")
    Set wsKategorien = ThisWorkbook.Worksheets("Kategorien")

    ' Letzte Zeile in "Rohdaten", "Zuweisung" und "Kategorien" finden
    lastRowRoh = wsRohdaten.Cells(wsRohdaten.Rows.Count, "A").End(xlUp).Row
    lastRowZuweisung = wsZuweisung.Cells(wsZuweisung.Rows.Count, "B").End(xlUp).Row
    lastRowKategorien = wsKategorien.Cells(wsKategorien.Rows.Count, "A").End(xlUp).Row

    Debug.Print "Letzte Zeile in Rohdaten: " & lastRowRoh
    Debug.Print "Letzte Zeile in Zuweisung: " & lastRowZuweisung
    Debug.Print "Letzte Zeile in Kategorien: " & lastRowKategorien

    ' Durch die Schlüssel in "Zuweisung" iterieren
    For i = 2 To lastRowZuweisung ' Starte bei 2, um Kopfzeile zu überspringen
        Schluessel = wsZuweisung.Cells(i, "B").Value
        ZielBlattName = wsZuweisung.Cells(i, "C").Value

        Debug.Print "Verarbeite Schlüssel: " & Schluessel & ", Zielblatt: " & ZielBlattName

        ' Ziel-Arbeitsblatt prüfen
        On Error Resume Next
        Set ZielWs = ThisWorkbook.Worksheets(ZielBlattName)
        On Error GoTo 0

        If Not ZielWs Is Nothing Then
            ' Starte ab Zeile 16
            zielRow = 16

            ' Text aus C12 im Zielarbeitsblatt für Überschriftensuche
            SuchText = ZielWs.Cells(12, "C").Value

            ' Daten aus "Rohdaten" finden
            For j = 2 To lastRowRoh
                If wsRohdaten.Cells(j, "A").Value = Schluessel Then
                    Debug.Print "Füge Daten ein in Zeile: " & zielRow & " des Blatts: " & ZielBlattName

                    ' Berechne Gestern oder letzten Freitag
                    Datum = wsRohdaten.Cells(j, "D").Value
                    If Weekday(Datum - 1, vbMonday) = 7 Then ' Wenn Sonntag
                        Gestern = Datum - 2 ' Letzter Freitag
                    Else
                        Gestern = Datum - 1 ' Normaler Vortag
                    End If

                    ' Kategorie aus "Kategorien" suchen
                    Kategorie = wsRohdaten.Cells(j, "C").Value
                    For k = 2 To lastRowKategorien
                        If wsKategorien.Cells(k, "A").Value = Kategorie Then
                            Kategorie = wsKategorien.Cells(k, "B").Value
                            Exit For
                        End If
                    Next k

                    ' Überschrift in Zeile 1 von "Rohdaten" suchen
                    headerCol = 0
                    For k = 1 To wsRohdaten.Cells(1, wsRohdaten.Columns.Count).End(xlToLeft).Column
                        If wsRohdaten.Cells(1, k).Value = SuchText Then
                            headerCol = k
                            Exit For
                        End If
                    Next k

                    ' Daten übertragen
                    ZielWs.Cells(zielRow, "A").Value = wsRohdaten.Cells(j, "B").Value ' Vorgangsnummer
                    ZielWs.Cells(zielRow, "B").Value = Kategorie ' Angepasste Kategorie aus "Kategorien"
                    ZielWs.Cells(zielRow, "U").Value = Gestern ' Datum von Gestern oder Freitag
                    ZielWs.Cells(zielRow, "V").Value = wsRohdaten.Cells(j, "D").Value ' Datum
                    ZielWs.Cells(zielRow, "W").Value = wsRohdaten.Cells(j, "E").Value ' Bemerkung
                    
                    If headerCol > 0 Then
                        ZielWs.Cells(zielRow, "C").Value = wsRohdaten.Cells(j, headerCol).Value ' Wert aus der gefundenen Spalte
                    Else
                        Debug.Print "Überschrift " & SuchText & " nicht in Rohdaten gefunden."
                    End If

                    zielRow = zielRow + 1 ' Nächste Zeile vorbereiten
                End If
            Next j
        Else
            Debug.Print "Das Arbeitsblatt " & ZielBlattName & " existiert nicht."
        End If
    Next i

    Debug.Print "Datenübertragung abgeschlossen!"
    MsgBox "Datenübertragung abgeschlossen!", vbInformation
End Sub
