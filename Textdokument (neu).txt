Sub ForwardingImport()
    Dim wsRohdaten As Worksheet, wsZuweisung As Worksheet, wsKategorien As Worksheet
    Dim ZielWs As Worksheet
    Dim lastRowRoh As Long, lastRowZuweisung As Long, lastRowKategorien As Long, zielRow As Long
    Dim i As Long, j As Long, k As Long
    Dim Schluessel As String, ZielBlattName As String
    Dim Datum As Date, Gestern As Variant
    Dim Kategorie As String
    Dim Kalenderwoche As String
    Dim cell As Range, headerCol As Long
    Dim SuchText As String, rohCol As Long

    ' Arbeitsblätter zuweisen
    Set wsRohdaten = ThisWorkbook.Worksheets("Rohdaten")
    Set wsZuweisung = ThisWorkbook.Worksheets("Zuweisung")
    Set wsKategorien = ThisWorkbook.Worksheets("Kategorien")

    ' Letzte Zeile in "Rohdaten", "Zuweisung" und "Kategorien" finden
    lastRowRoh = wsRohdaten.Cells(wsRohdaten.Rows.Count, "A").End(xlUp).Row
    lastRowZuweisung = wsZuweisung.Cells(wsZuweisung.Rows.Count, "F").End(xlUp).Row
    lastRowKategorien = wsKategorien.Cells(wsKategorien.Rows.Count, "A").End(xlUp).Row

    Debug.Print "Letzte Zeile in Rohdaten: " & lastRowRoh
    Debug.Print "Letzte Zeile in Zuweisung: " & lastRowZuweisung
    Debug.Print "Letzte Zeile in Kategorien: " & lastRowKategorien

    ' Durch die Schlüssel in "Zuweisung" iterieren
    For i = 2 To lastRowZuweisung ' Starte bei 2, um Kopfzeile zu überspringen
        Schluessel = wsZuweisung.Cells(i, "F").Value
        ZielBlattName = wsZuweisung.Cells(i, "G").Value

        Debug.Print "Verarbeite Schlüssel: " & Schluessel & ", Zielblatt: " & ZielBlattName

        ' Ziel-Arbeitsblatt prüfen
        On Error Resume Next
        Set ZielWs = ThisWorkbook.Worksheets(ZielBlattName)
        On Error GoTo 0

        If Not ZielWs Is Nothing Then
            Debug.Print "Überprüfe Arbeitsblatt: " & ZielBlattName

            ' Daten aus "Rohdaten" finden
            For j = 2 To lastRowRoh
                If wsRohdaten.Cells(j, "A").Value = Schluessel Then
                    ' Berechne Gestern oder letzten Freitag
                    Datum = wsRohdaten.Cells(j, "F").Value
                    If Datum <> 0 Then ' Sicherstellen, dass Datum gültig ist
                        If Weekday(Datum - 1, vbMonday) = 7 Then ' Wenn Sonntag
                            Gestern = Datum - 3 ' Letzter Freitag
                        Else
                            Gestern = Datum - 1 ' Normaler Vortag
                        End If
                    Else
                        Debug.Print "Ungültiges Datum in Rohdaten: Zeile " & j
                        Gestern = "" ' Leerer Wert für ungültiges Datum
                    End If

                    ' Kategorie aus "Kategorien" suchen
                    Kategorie = wsRohdaten.Cells(j, "C").Value
                    For k = 2 To lastRowKategorien
                        If wsKategorien.Cells(k, "A").Value = Kategorie Then
                            Kategorie = wsKategorien.Cells(k, "B").Value
                            Exit For
                        End If
                    Next k

                    ' Kalenderwoche berechnen
                    Kalenderwoche = "KW " & Format(Application.WeekNum(Gestern, vbMonday), "00")

                    ' Debugging für Kalenderwoche
                    Debug.Print "Berechnete KW: " & Kalenderwoche

                    ' Alle Zellen mit der Kalenderwoche in den ersten 500 Zeilen suchen
                    For Each cell In ZielWs.Range("A1:A500")
                        If Trim(cell.Value) = Kalenderwoche Then
                            Debug.Print "Gefundene KW-Zelle im Blatt " & ZielBlattName & ": Zeile " & cell.Row & ", Inhalt: " & cell.Value
                            zielRow = cell.Row + 7 ' 7 Zeilen unter der gefundenen Zelle beginnen

                            ' Wochentag aus der Variable "Gestern" berechnen
                            Dim Wochentag As String
                            Wochentag = Format(Gestern, "dddd")

                            ' Suche nach dem Wochentag in Spalte Y ab der gefundenen KW-Zeile
                            Dim foundRow As Long
                            foundRow = 0
                            For k = zielRow To 500
                                If ZielWs.Cells(k, "Y").Value = Wochentag Then
                                    foundRow = k
                                    Exit For
                                End If
                            Next k

                            If foundRow = 0 Then
                                MsgBox "Wochentag nicht gefunden oder kein Platz verfügbar.", vbExclamation
                                Exit Sub
                            End If

                            ' Ab der gefundenen Wochentagszeile die nächste freie Zeile suchen
                            zielRow = foundRow
                            Do While ZielWs.Cells(zielRow, "A").Value <> ""
                                zielRow = zielRow + 1
                            Loop

                            Debug.Print "Füge Daten ein in Zeile: " & zielRow & " des Blatts: " & ZielBlattName

                            ' Daten übertragen
                            ZielWs.Cells(zielRow, "A").Value = wsRohdaten.Cells(j, "B").Value ' Vorgangsnummer
                            ZielWs.Cells(zielRow, "B").Value = Kategorie ' Angepasste Kategorie
                            ZielWs.Cells(zielRow, "C").Value = Gestern ' Datum von Gestern oder Freitag
                            ZielWs.Cells(zielRow, "J").Value = Format(wsRohdaten.Cells(j, "F").Value, "dd.mm.") ' Datum
                            ZielWs.Cells(zielRow, "K").Value = wsRohdaten.Cells(j, "G").Value ' Bemerkung

                            ' Texte für Fragen suchen und einfügen (Spalten D10 bis F10)
                            For headerCol = 4 To 6 ' Spalten D bis F im Zielarbeitsblatt
                                SuchText = "Frage: " & ZielWs.Cells(10, headerCol).Value

                                ' Überschrift in Zeile 1 von "Rohdaten" suchen
                                rohCol = 0
                                For k = 1 To wsRohdaten.Cells(1, wsRohdaten.Columns.Count).End(xlToLeft).Column
                                    If wsRohdaten.Cells(1, k).Value = SuchText Then
                                        rohCol = k
                                        Exit For
                                    End If
                                Next k

                                If rohCol > 0 Then
                                    Dim rohWert As String
                                    rohWert = wsRohdaten.Cells(j, rohCol).Value

                                    ' Überschreiben der Werte
                                    Select Case rohWert
                                        Case "Ja"
                                            ZielWs.Cells(zielRow, headerCol).Value = "j"
                                        Case "Nein"
                                            ZielWs.Cells(zielRow, headerCol).Value = "n"
                                        Case "Teilweise"
                                            ZielWs.Cells(zielRow, headerCol).Value = "t"
                                        Case "N/A"
                                            ZielWs.Cells(zielRow, headerCol).Value = ""
                                        Case Else
                                            ZielWs.Cells(zielRow, headerCol).Value = rohWert
                                    End Select
                                Else
                                    Debug.Print "Überschrift " & SuchText & " nicht in Rohdaten gefunden."
                                End If
                            Next headerCol

                        End If
                    Next cell
                End If
            Next j
        Else
            Debug.Print "Das Arbeitsblatt " & ZielBlattName & " existiert nicht."
        End If
    Next i

    Debug.Print "Datenübertragung abgeschlossen!"
    ServiceImport
End Sub
