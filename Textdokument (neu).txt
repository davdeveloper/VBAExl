Sub ImportAndTransformData()
    Dim wsDashboard As Worksheet
    Dim wsRohdaten As Worksheet
    Dim wbImport As Workbook
    Dim filePath As String
    Dim lastRow As Long, i As Long
    Dim dict As Object
    Dim key As String
    Dim questionCol As Long, answerCol As Long
    Dim newLastRow As Long

    ' Set the dashboard worksheet
    Set wsDashboard = ThisWorkbook.Sheets("Dashboard")
    Set wsRohdaten = ThisWorkbook.Sheets("Rohdaten")

    ' Ask user to select the file to import
    With Application.FileDialog(msoFileDialogFilePicker)
        .Title = "Wählen Sie die Datei Leaptree_Data aus"
        .Filters.Clear
        .Filters.Add "Excel Dateien", "*.xls; *.xlsx; *.xlsm"
        If .Show <> -1 Then Exit Sub ' Abbrechen, wenn keine Datei ausgewählt wurde
        filePath = .SelectedItems(1)
    End With

    ' Open the selected workbook
    Set wbImport = Workbooks.Open(filePath)

    ' Get the last row of data in the imported workbook (assuming data is in the first sheet)
    With wbImport.Sheets(1)
        lastRow = .Cells(.Rows.Count, 2).End(xlUp).Row
    End With

    ' Initialize dictionary for storing transformed data
    Set dict = CreateObject("Scripting.Dictionary")

    ' Read and transform the data
    With wbImport.Sheets(1)
        For i = 2 To lastRow
            key = .Cells(i, 2).Value ' Vorgangsnummer in Spalte B
            If Not dict.exists(key) Then
                dict(key) = Array(.Cells(i, 1).Resize(1, 12).Value, "") ' Alle Spalten von A bis M
            End If
            ' Add question and answer to dynamic columns
            dict(key)(1) = dict(key)(1) & "|" & .Cells(i, 10).Value & ":" & .Cells(i, 11).Value
        Next i
    End With

    ' Close the imported workbook
    wbImport.Close SaveChanges:=False

    ' Clear existing data in Rohdaten sheet (except header)
    wsRohdaten.Rows("2:" & wsRohdaten.Rows.Count).Clear

    ' Write transformed data to the Rohdaten sheet
    newLastRow = 2
    For Each key In dict.keys
        Dim rowData As Variant
        Dim extraData As String
        Dim extraParts As Variant
        Dim colIndex As Long

        rowData = dict(key)(0)
        extraData = dict(key)(1)
        wsRohdaten.Cells(newLastRow, 1).Resize(1, UBound(rowData, 2)).Value = rowData

        ' Add dynamic columns for questions and answers
        If Len(extraData) > 0 Then
            extraParts = Split(Mid(extraData, 2), "|") ' Remove leading | and split
            colIndex = 14 ' Start after column M
            For Each part In extraParts
                Dim qaPair As Variant
                qaPair = Split(part, ":")
                If UBound(qaPair) = 1 Then
                    wsRohdaten.Cells(1, colIndex).Value = "Frage " & qaPair(0) ' Header for question
                    wsRohdaten.Cells(newLastRow, colIndex).Value = qaPair(1) ' Answer
                    colIndex = colIndex + 1
                End If
            Next part
        End If
        newLastRow = newLastRow + 1
    Next key

    MsgBox "Daten wurden erfolgreich importiert und transformiert!", vbInformation
End Sub
