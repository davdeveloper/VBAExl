Sub DatenZuweisung()
    Dim wsRohdaten As Worksheet, wsZuweisung As Worksheet, wsKategorien As Worksheet, wsTemp As Worksheet
    Dim ZielWs As Worksheet
    Dim lastRowRoh As Long, lastRowZuweisung As Long, lastRowKategorien As Long, lastRowTemp As Long, zielRow As Long
    Dim i As Long, j As Long, k As Long, headerCol As Long
    Dim Schluessel As String, ZielBlattName As String
    Dim Datum As Date, Gestern As Variant
    Dim Kategorie As String, SuchText As String
    Dim Kalenderwoche As String, Wochentag As String
    Dim cell As Range
    Dim OriginalWert As String, MappingWert As String
    Dim splitArray() As String
    Dim wbZuweisungName As Workbook
    Dim filePath As String

    ' Arbeitsblätter zuweisen
    Set wsRohdaten = ThisWorkbook.Worksheets("Rohdaten")
    Set wsZuweisung = ThisWorkbook.Worksheets("Zuweisung")
    Set wsKategorien = ThisWorkbook.Worksheets("Kategorien")
    
    ' Pfad der Datei "ZuweisungName" anpassen (im gleichen Verzeichnis wie die Hauptdatei)
    filePath = ThisWorkbook.Path & "\\ZuweisungName.xlsx"
    
    ' Datei "ZuweisungName" öffnen und Daten in ein temporäres Arbeitsblatt kopieren
    On Error Resume Next
    Set wbZuweisungName = Workbooks.Open(filePath, Password:="zary87")
    On Error GoTo 0
    
    If wbZuweisungName Is Nothing Then
        MsgBox "Die Datei ZuweisungName.xlsx konnte nicht geöffnet werden!", vbCritical
        Exit Sub
    End If
    
    ' Temporäres Arbeitsblatt erstellen
    Application.ScreenUpdating = False
    On Error Resume Next
    Set wsTemp = ThisWorkbook.Sheets("TempZuweisung")
    If Not wsTemp Is Nothing Then ThisWorkbook.Sheets("TempZuweisung").Delete
    On Error GoTo 0
    Set wsTemp = ThisWorkbook.Sheets.Add
    wsTemp.Name = "TempZuweisung"
    
    ' Kopiere Daten aus ZuweisungName in das temporäre Arbeitsblatt
    wbZuweisungName.Sheets(1).Cells.Copy
    wsTemp.Cells(1, 1).PasteSpecial Paste:=xlPasteValues
    Application.CutCopyMode = False
    
    ' Schließe die Datei nach dem Kopieren
    wbZuweisungName.Close False
    Set wbZuweisungName = Nothing
    
    ' Letzte Zeile im temporären Arbeitsblatt bestimmen
    lastRowTemp = wsTemp.Cells(wsTemp.Rows.Count, "A").End(xlUp).Row

    ' Letzte Zeile in "Rohdaten", "Zuweisung" und "Kategorien" finden
    lastRowRoh = wsRohdaten.Cells(wsRohdaten.Rows.Count, "A").End(xlUp).Row
    lastRowZuweisung = wsZuweisung.Cells(wsZuweisung.Rows.Count, "B").End(xlUp).Row
    lastRowKategorien = wsKategorien.Cells(wsKategorien.Rows.Count, "A").End(xlUp).Row

    ' Durch die Schlüssel in "Zuweisung" iterieren
    For i = 2 To lastRowZuweisung
        Schluessel = wsZuweisung.Cells(i, "B").Value
        ZielBlattName = wsZuweisung.Cells(i, "C").Value

        ' Ziel-Arbeitsblatt prüfen
        On Error Resume Next
        Set ZielWs = ThisWorkbook.Worksheets(ZielBlattName)
        On Error GoTo 0

        If Not ZielWs Is Nothing Then
            ZielWs.Activate ' Arbeitsblatt aktivieren, um Fehler zu vermeiden
            
            ' Daten aus "Rohdaten" finden
            For j = 2 To lastRowRoh
                If wsRohdaten.Cells(j, "A").Value = Schluessel Then
                    ' Kalenderwoche berechnen
                    Datum = wsRohdaten.Cells(j, "F").Value
                    If Datum <> 0 Then
                        If Weekday(Datum - 1, vbMonday) = 7 Then
                            Gestern = Datum - 3
                        Else
                            Gestern = Datum - 1
                        End If
                    Else
                        Gestern = ""
                    End If

                    ' Kategorie aus "Kategorien" suchen
                    Kategorie = wsRohdaten.Cells(j, "C").Value
                    For k = 2 To lastRowKategorien
                        If wsKategorien.Cells(k, "A").Value = Kategorie Then
                            Kategorie = wsKategorien.Cells(k, "B").Value
                            Exit For
                        End If
                    Next k

                    Kalenderwoche = "KW " & Format(Application.WeekNum(Gestern, vbMonday), "00")
                    
                    ' Namen aus Spalte O extrahieren und in TempZuweisung suchen
                    OriginalWert = wsRohdaten.Cells(j, "O").Value
                    splitArray = Split(OriginalWert, " ")
                    MappingWert = ""
                    
                    For k = 2 To lastRowTemp
                        If wsTemp.Cells(k, "A").Value = splitArray(0) Then
                            MappingWert = wsTemp.Cells(k, "B").Value
                            Exit For
                        End If
                    Next k
                    
                    ' Daten übertragen
                    ZielWs.Cells(zielRow, "A").Value = wsRohdaten.Cells(j, "B").Value
                    ZielWs.Cells(zielRow, "B").Value = Kategorie
                    ZielWs.Cells(zielRow, "U").Value = Gestern
                    ZielWs.Cells(zielRow, "V").Value = Format(wsRohdaten.Cells(j, "F").Value, "dd.mm.")
                    ZielWs.Cells(zielRow, "W").Value = wsRohdaten.Cells(j, "G").Value
                    ZielWs.Cells(zielRow, "X").Value = MappingWert
                End If
            Next j
        End If
    Next i
    
    ' Temporäres Arbeitsblatt löschen
    Application.DisplayAlerts = False
    wsTemp.Delete
    Application.DisplayAlerts = True
    
    Debug.Print "Datenübertragung abgeschlossen!"
    ForwardingImport
End Sub
