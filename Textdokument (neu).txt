Sub ImportUndTransformierenRohdaten()
    Dim wsRohdaten As Worksheet
    Dim letzteZeile As Long, letzteSpalte As Long
    Dim dict As Object
    Dim schluessel As Variant, vorgangsnummer As Variant
    Dim i As Long, j As Long, neueSpalte As Long
    Dim frage As Variant, antwort As String
    Dim datenDatei As Variant
    Dim wbQuelle As Workbook

    ' Datei-Auswahldialog
    datenDatei = Application.GetOpenFilename("Excel Dateien (*.xls; *.xlsx), *.xls; *.xlsx", , "Wählen Sie die Rohdaten-Datei aus")

    If datenDatei = False Then
        MsgBox "Es wurde keine Datei ausgewählt.", vbExclamation
        Exit Sub
    End If

    ' Rohdaten-Datei öffnen
    Set wbQuelle = Workbooks.Open(datenDatei)

    ' Setze das Arbeitsblatt für Rohdaten
    Set wsRohdaten = ThisWorkbook.Sheets("Rohdaten")

    ' Lösche alle existierenden Daten im Arbeitsblatt Rohdaten
    wsRohdaten.Cells.Clear

    ' Letzte Zeile und Spalte in der Quelldatei finden
    With wbQuelle.Sheets(1)
        letzteZeile = .Cells(.Rows.Count, 1).End(xlUp).Row
        letzteSpalte = .Cells(1, .Columns.Count).End(xlToLeft).Column
    End With

    ' Daten in das Arbeitsblatt Rohdaten kopieren
    wbQuelle.Sheets(1).Cells(1, 1).Resize(letzteZeile, letzteSpalte).Copy wsRohdaten.Cells(1, 1)

    ' Quelldatei schließen
    wbQuelle.Close SaveChanges:=False

    ' Dictionary zur Zusammenführung der Daten
    Set dict = CreateObject("Scripting.Dictionary")

    ' Rohdaten verarbeiten und in das Dictionary schreiben
    For i = 2 To letzteZeile ' Überspringe Kopfzeile
        vorgangsnummer = wsRohdaten.Cells(i, 2).Value
        frage = wsRohdaten.Cells(i, 10).Value
        antwort = wsRohdaten.Cells(i, 12).Value

        ' Wenn die Vorgangsnummer noch nicht im Dictionary ist, hinzufügen
        If Not dict.exists(vorgangsnummer) Then
            dict(vorgangsnummer) = Array(wsRohdaten.Rows(i).Value, CreateObject("Scripting.Dictionary"))
        End If

        ' Frage und Antwort hinzufügen, auch wenn leer
        dict(vorgangsnummer)(1)(frage) = antwort
    Next i

    ' Daten im Arbeitsblatt Rohdaten transformieren
    neueSpalte = letzteSpalte + 1
    j = 2 ' Startzeile für Daten

    For Each vorgangsnummer In dict.Keys
        ' Rohdaten zur Vorgangsnummer
        wsRohdaten.Cells(j, 1).Resize(1, letzteSpalte).Value = dict(vorgangsnummer)(0)

        ' Fragen und Antworten hinzufügen, wenn vorhanden
        If dict(vorgangsnummer)(1).Count > 0 Then
            For Each frage In dict(vorgangsnummer)(1).keys
                If Not IsEmpty(frage) Then
                    If wsRohdaten.Cells(1, neueSpalte).Value = "" Then
                        wsRohdaten.Cells(1, neueSpalte).Value = "Frage: " & frage
                    End If
                    wsRohdaten.Cells(j, neueSpalte).Value = dict(vorgangsnummer)(1)(frage)
                    neueSpalte = neueSpalte + 1
                End If
            Next frage
        End If

        neueSpalte = letzteSpalte + 1 ' Zurücksetzen für nächste Vorgangsnummer
        j = j + 1
    Next vorgangsnummer

    ' Entferne doppelte Vorgangsnummern durch Sortierung und eindeutige Einträge
    Dim letzteZeileNach As Long
    letzteZeileNach = wsRohdaten.Cells(wsRohdaten.Rows.Count, 2).End(xlUp).Row

    Dim uniqueDict As Object
    Set uniqueDict = CreateObject("Scripting.Dictionary")

    For i = 2 To letzteZeileNach
        vorgangsnummer = wsRohdaten.Cells(i, 2).Value
        If Not uniqueDict.exists(vorgangsnummer) Then
            uniqueDict(vorgangsnummer) = i
        Else
            wsRohdaten.Rows(i).Delete
            i = i - 1
            letzteZeileNach = letzteZeileNach - 1
        End If
    Next i

    MsgBox "Die Rohdaten wurden erfolgreich importiert und transformiert!", vbInformation

End Sub
