Sub ImportDataFromLeaptree()
    Dim wsRohdaten As Worksheet, wsDashboard As Worksheet, wsZuweisung As Worksheet
    Dim lastRowRohdaten As Long, lastRowZuweisung As Long, lastRowDashboard As Long
    Dim dataSheetName As String, key As String, vorgangsnummer As String
    Dim i As Long, j As Long, dashboardRow As Long
    Dim questionColumn As Range, cell As Range
    Dim currentVorgangsnummer As String
    Dim foundRow As Long

    ' Arbeitsblätter definieren
    Set wsRohdaten = Workbooks("Leaptree_Data.xlsx").Worksheets(1)
    Set wsZuweisung = ThisWorkbook.Worksheets("Zuweisung")

    ' Letzte Zeile in den Rohdaten finden
    lastRowRohdaten = wsRohdaten.Cells(wsRohdaten.Rows.Count, "A").End(xlUp).Row

    ' Letzte Zeile in Zuweisung finden
    lastRowZuweisung = wsZuweisung.Cells(wsZuweisung.Rows.Count, "A").End(xlUp).Row

    ' Dashboard-Daten importieren
    For i = 2 To lastRowRohdaten
        key = wsRohdaten.Cells(i, "A").Value
        vorgangsnummer = wsRohdaten.Cells(i, "B").Value

        ' Nur Schlüssel verarbeiten, die in der Zuweisung existieren
        dataSheetName = ""
        For j = 2 To lastRowZuweisung
            If wsZuweisung.Cells(j, "A").Value = key Then
                dataSheetName = wsZuweisung.Cells(j, "C").Value
                Exit For
            End If
        Next j

        If dataSheetName = "" Then
            GoTo NextIteration
        End If

        ' Arbeitsblatt öffnen
        On Error Resume Next
        Set wsDashboard = ThisWorkbook.Worksheets(dataSheetName)
        On Error GoTo 0

        If wsDashboard Is Nothing Then
            MsgBox "Arbeitsblatt " & dataSheetName & " nicht gefunden!", vbExclamation
            GoTo NextIteration
        End If

        ' Letzte verwendete Zeile im Dashboard
        lastRowDashboard = wsDashboard.Cells(wsDashboard.Rows.Count, "A").End(xlUp).Row

        ' Prüfen, ob Vorgangsnummer bereits existiert
        foundRow = 0
        For dashboardRow = 16 To lastRowDashboard
            If wsDashboard.Cells(dashboardRow, "A").Value = vorgangsnummer Then
                foundRow = dashboardRow
                Exit For
            End If
        Next dashboardRow

        ' Neue Zeile für Vorgangsnummer, wenn nicht vorhanden
        If foundRow = 0 Then
            foundRow = lastRowDashboard + 1
            wsDashboard.Cells(foundRow, "A").Value = vorgangsnummer
            wsDashboard.Cells(foundRow, "B").Value = wsRohdaten.Cells(i, "C").Value
            wsDashboard.Cells(foundRow, "V").Value = wsRohdaten.Cells(i, "D").Value
        End If

        ' Fragen und Antworten zuordnen
        Set questionColumn = wsDashboard.Range("C12:Q12")
        For Each cell In questionColumn
            If cell.Value = wsRohdaten.Cells(i, "J").Value Then
                wsDashboard.Cells(foundRow, cell.Column).Value = wsRohdaten.Cells(i, "L").Value
                Exit For
            End If
        Next cell

NextIteration:
    Next i

    MsgBox "Daten erfolgreich importiert!"
End Sub
