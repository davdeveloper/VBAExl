Sub DatenZuweisung()
    Dim wsRohdaten As Worksheet
    Dim wsZuweisung As Worksheet
    Dim ZielBlatt As Worksheet
    Dim letzteZeileRoh As Long, letzteZeileZuweisung As Long
    Dim i As Long, j As Long
    Dim Schluessel As String
    Dim ZielName As String
    Dim Vorgangsnummer As String
    Dim Kategorie As String
    Dim Datum As String
    Dim Wert As String

    ' Arbeitsblätter definieren
    Set wsRohdaten = ThisWorkbook.Sheets("Rohdaten")
    Debug.Print "Arbeitsblatt Rohdaten gesetzt"
    Set wsZuweisung = ThisWorkbook.Sheets("Zuweisung")
    Debug.Print "Arbeitsblatt Zuweisung gesetzt"

    ' Letzte Zeile in den Arbeitsblättern finden
    letzteZeileRoh = wsRohdaten.Cells(wsRohdaten.Rows.Count, 1).End(xlUp).Row
    Debug.Print "Letzte Zeile in Rohdaten: " & letzteZeileRoh
    letzteZeileZuweisung = wsZuweisung.Cells(wsZuweisung.Rows.Count, 1).End(xlUp).Row
    Debug.Print "Letzte Zeile in Zuweisung: " & letzteZeileZuweisung

    ' Durch die Zeilen der Rohdaten iterieren
    For i = 2 To letzteZeileRoh ' Annahme: Header in Zeile 1
        Schluessel = wsRohdaten.Cells(i, 1).Value
        Vorgangsnummer = wsRohdaten.Cells(i, 2).Value
        Kategorie = wsRohdaten.Cells(i, 3).Value
        Datum = wsRohdaten.Cells(i, 4).Value
        Wert = wsRohdaten.Cells(i, 5).Value

        Debug.Print "Verarbeite Zeile " & i & ": Schlüssel=" & Schluessel

        ' Nach Schlüssel im Arbeitsblatt "Zuweisung" suchen
        For j = 2 To letzteZeileZuweisung
            Debug.Print "Prüfe Schlüssel in Zuweisung Zeile " & j
            If wsZuweisung.Cells(j, 2).Value = Schluessel Then
                ZielName = wsZuweisung.Cells(j, 3).Value
                Debug.Print "Schlüssel gefunden: Zielblatt=" & ZielName

                ' Ziel-Arbeitsblatt überprüfen und Daten einfügen
                On Error Resume Next
                Set ZielBlatt = ThisWorkbook.Sheets(ZielName)
                If Err.Number <> 0 Then
                    Debug.Print "Fehler: Zielblatt " & ZielName & " existiert nicht."
                    Err.Clear
                    On Error GoTo 0
                    Exit For
                End If
                On Error GoTo 0

                If Not ZielBlatt Is Nothing Then
                    Debug.Print "Daten werden ab Zeile 16 eingefügt in Zielblatt " & ZielName

                    ZielBlatt.Cells(16, 1).Value = Vorgangsnummer
                    ZielBlatt.Cells(16, 2).Value = Kategorie
                    ZielBlatt.Cells(16, 3).Value = Datum
                    ZielBlatt.Cells(16, 4).Value = Wert

                    Debug.Print "Daten eingefügt in " & ZielName & " (ab Zeile 16)"
                End If

                ' Zielblatt-Referenz zurücksetzen
                Set ZielBlatt = Nothing

                ' Schlüssel gefunden, nächste Zeile
                Exit For
            End If
        Next j
    Next i

    MsgBox "Datenzuweisung abgeschlossen!", vbInformation
    Debug.Print "Datenzuweisung abgeschlossen!"
End Sub
