Sub DatenZuweisung()
    Dim wsRohdaten As Worksheet, wsZuweisung As Worksheet, wsKategorien As Worksheet, wsZuweisungName As Worksheet
    Dim ZielWs As Worksheet
    Dim lastRowRoh As Long, lastRowZuweisung As Long, lastRowKategorien As Long, zielRow As Long
    Dim i As Long, j As Long, k As Long, headerCol As Long
    Dim Schluessel As String, ZielBlattName As String
    Dim Datum As Date, Gestern As Variant
    Dim Kategorie As String, SuchText As String
    Dim Kalenderwoche As String, Wochentag As String
    Dim cell As Range
    Dim lastRowMap As Long
    Dim OriginalWert As String, MappingWert As String
    Dim splitArray() As String

    ' Arbeitsblätter zuweisen
    Set wsRohdaten = ThisWorkbook.Worksheets("Rohdaten")
    Set wsZuweisung = ThisWorkbook.Worksheets("Zuweisung")
    Set wsKategorien = ThisWorkbook.Worksheets("Kategorien")
    Set wsZuweisungName = ThisWorkbook.Worksheets("ZuweisungName") ' Arbeitsblatt direkt in der Mappe
    
    ' Letzte Zeile in "Rohdaten", "Zuweisung" und "Kategorien" finden
    lastRowRoh = wsRohdaten.Cells(wsRohdaten.Rows.Count, "A").End(xlUp).Row
    lastRowZuweisung = wsZuweisung.Cells(wsZuweisung.Rows.Count, "B").End(xlUp).Row
    lastRowKategorien = wsKategorien.Cells(wsKategorien.Rows.Count, "A").End(xlUp).Row
    lastRowMap = wsZuweisungName.Cells(wsZuweisungName.Rows.Count, "A").End(xlUp).Row

    ' Durch die Schlüssel in "Zuweisung" iterieren
    For i = 2 To lastRowZuweisung
        Schluessel = wsZuweisung.Cells(i, "B").Value
        ZielBlattName = wsZuweisung.Cells(i, "C").Value

        ' Ziel-Arbeitsblatt prüfen
        On Error Resume Next
        Set ZielWs = ThisWorkbook.Worksheets(ZielBlattName)
        On Error GoTo 0

        If Not ZielWs Is Nothing Then
            ' Daten aus "Rohdaten" finden
            For j = 2 To lastRowRoh
                If wsRohdaten.Cells(j, "A").Value = Schluessel Then
                    ' Kalenderwoche berechnen
                    Datum = wsRohdaten.Cells(j, "F").Value
                    If Datum <> 0 Then
                        If Weekday(Datum - 1, vbMonday) = 7 Then
                            Gestern = Datum - 3
                        Else
                            Gestern = Datum - 1
                        End If
                    Else
                        Gestern = ""
                    End If

                    ' Kategorie aus "Kategorien" suchen
                    Kategorie = wsRohdaten.Cells(j, "C").Value
                    For k = 2 To lastRowKategorien
                        If wsKategorien.Cells(k, "A").Value = Kategorie Then
                            Kategorie = wsKategorien.Cells(k, "B").Value
                            Exit For
                        End If
                    Next k

                    Kalenderwoche = "KW " & Format(Application.WeekNum(Gestern, vbMonday), "00")
                    
                    ' Namen aus Spalte O extrahieren und in "ZuweisungName" suchen
                    OriginalWert = wsRohdaten.Cells(j, "O").Value
                    splitArray = Split(OriginalWert, " ")
                    MappingWert = OriginalWert ' Standardwert beibehalten
                    For k = 2 To lastRowMap
                        If wsZuweisungName.Cells(k, "A").Value = splitArray(0) Then
                            MappingWert = wsZuweisungName.Cells(k, "B").Value
                            Exit For
                        End If
                    Next k
                    
                    ' Daten übertragen
                    ZielWs.Cells(zielRow, "A").Value = wsRohdaten.Cells(j, "B").Value
                    ZielWs.Cells(zielRow, "B").Value = Kategorie
                    ZielWs.Cells(zielRow, "U").Value = Gestern
                    ZielWs.Cells(zielRow, "V").Value = Format(wsRohdaten.Cells(j, "F").Value, "dd.mm.")
                    ZielWs.Cells(zielRow, "W").Value = wsRohdaten.Cells(j, "G").Value
                    ZielWs.Cells(zielRow, "X").Value = MappingWert
                End If
            Next j
        End If
    Next i
    
    Debug.Print "Datenübertragung abgeschlossen!"
    ForwardingImport
End Sub