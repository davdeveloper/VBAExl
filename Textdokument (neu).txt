Sub ImportAndTransformData()
    Dim wsDashboard As Worksheet
    Dim wsRohdaten As Worksheet
    Dim wbImport As Workbook
    Dim filePath As String
    Dim lastRow As Long, i As Long
    Dim dict As Object
    Dim keysArray As Variant
    Dim key As Variant
    Dim questionDict As Object
    Dim newLastRow As Long
    Dim headersDict As Object

    ' Set the dashboard worksheet
    Set wsDashboard = ThisWorkbook.Sheets("Dashboard")
    Set wsRohdaten = ThisWorkbook.Sheets("Rohdaten")

    ' Ask user to select the file to import
    With Application.FileDialog(msoFileDialogFilePicker)
        .Title = "Wählen Sie die Datei Leaptree_Data aus"
        .Filters.Clear
        .Filters.Add "Excel Dateien", "*.xls; *.xlsx; *.xlsm"
        If .Show <> -1 Then Exit Sub ' Abbrechen, wenn keine Datei ausgewählt wurde
        filePath = .SelectedItems(1)
    End With

    ' Open the selected workbook
    Set wbImport = Workbooks.Open(filePath)

    ' Get the last row of data in the imported workbook (assuming data is in the first sheet)
    With wbImport.Sheets(1)
        lastRow = .Cells(.Rows.Count, 2).End(xlUp).Row
    End With

    ' Initialize dictionaries for storing transformed data and headers
    Set dict = CreateObject("Scripting.Dictionary")
    Set headersDict = CreateObject("Scripting.Dictionary")

    ' Read and transform the data
    With wbImport.Sheets(1)
        For i = 2 To lastRow
            key = .Cells(i, 2).Value ' Vorgangsnummer in Spalte B
            If Not dict.exists(key) Then
                Set questionDict = CreateObject("Scripting.Dictionary")
                dict(key) = Array(.Cells(i, 1).Resize(1, 12).Value, questionDict)
            Else
                Set questionDict = dict(key)(1)
            End If
            ' Add question and answer to the question dictionary
            questionDict(.Cells(i, 10).Value) = .Cells(i, 11).Value
            ' Track unique questions for headers
            If Not headersDict.exists(.Cells(i, 10).Value) Then
                headersDict(.Cells(i, 10).Value) = headersDict.Count + 14 ' Dynamic column starting at column 14
            End If
        Next i
    End With

    ' Close the imported workbook
    wbImport.Close SaveChanges:=False

    ' Clear existing data in Rohdaten sheet (except header)
    wsRohdaten.Rows("2:" & wsRohdaten.Rows.Count).Clear

    ' Write headers for questions dynamically
    Dim headerKey As Variant
    For Each headerKey In headersDict.Keys
        wsRohdaten.Cells(1, headersDict(headerKey)).Value = "Frage " & headerKey
    Next headerKey

    ' Write transformed data to the Rohdaten sheet
    keysArray = dict.Keys ' Alle Schlüssel in ein Array speichern
    newLastRow = 2

    For Each key In keysArray
        Dim rowData As Variant
        Dim colIndex As Long
        Dim questionKey As Variant

        rowData = dict(key)(0)
        Set questionDict = dict(key)(1)
        wsRohdaten.Cells(newLastRow, 1).Resize(1, UBound(rowData, 2)).Value = rowData

        ' Add dynamic columns for questions and answers
        For Each questionKey In questionDict.Keys
            colIndex = headersDict(questionKey)
            wsRohdaten.Cells(newLastRow, colIndex).Value = questionDict(questionKey) ' Answer
        Next questionKey

        newLastRow = newLastRow + 1
    Next key

    MsgBox "Daten wurden erfolgreich importiert und transformiert!", vbInformation
End Sub
