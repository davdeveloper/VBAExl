Sub DatenZuweisung()
    Dim wsRohdaten As Worksheet, wsZuweisung As Worksheet
    Dim ZielWs As Worksheet
    Dim lastRowRoh As Long, lastRowZuweisung As Long, zielRow As Long
    Dim i As Long, j As Long
    Dim Schluessel As String, ZielBlattName As String
    Dim Datum As Date, Gestern As Date

    ' Arbeitsblätter zuweisen
    Set wsRohdaten = ThisWorkbook.Worksheets("Rohdaten")
    Set wsZuweisung = ThisWorkbook.Worksheets("Zuweisung")
    
    ' Letzte Zeile in "Rohdaten" und "Zuweisung" finden
    lastRowRoh = wsRohdaten.Cells(wsRohdaten.Rows.Count, "A").End(xlUp).Row
    lastRowZuweisung = wsZuweisung.Cells(wsZuweisung.Rows.Count, "B").End(xlUp).Row

    Debug.Print "Letzte Zeile in Rohdaten: " & lastRowRoh
    Debug.Print "Letzte Zeile in Zuweisung: " & lastRowZuweisung

    ' Durch die Schlüssel in "Zuweisung" iterieren
    For i = 2 To lastRowZuweisung ' Starte bei 2, um Kopfzeile zu überspringen
        Schluessel = wsZuweisung.Cells(i, "B").Value
        ZielBlattName = wsZuweisung.Cells(i, "C").Value
        
        Debug.Print "Verarbeite Schlüssel: " & Schluessel & ", Zielblatt: " & ZielBlattName
        
        ' Ziel-Arbeitsblatt prüfen
        On Error Resume Next
        Set ZielWs = ThisWorkbook.Worksheets(ZielBlattName)
        On Error GoTo 0

        If Not ZielWs Is Nothing Then
            ' Starte ab Zeile 16
            zielRow = 16

            ' Daten aus "Rohdaten" finden
            For j = 2 To lastRowRoh
                If wsRohdaten.Cells(j, "A").Value = Schluessel Then
                    Debug.Print "Füge Daten ein in Zeile: " & zielRow & " des Blatts: " & ZielBlattName

                    ' Berechne Gestern oder letzten Freitag
                    Datum = wsRohdaten.Cells(j, "D").Value
                    If Weekday(Datum - 1, vbMonday) = 7 Then ' Wenn Sonntag
                        Gestern = Datum - 2 ' Letzter Freitag
                    Else
                        Gestern = Datum - 1 ' Normaler Vortag
                    End If

                    ' Daten übertragen
                    ZielWs.Cells(zielRow, "A").Value = wsRohdaten.Cells(j, "B").Value ' Vorgangsnummer
                    ZielWs.Cells(zielRow, "B").Value = wsRohdaten.Cells(j, "C").Value ' Kategorie
                    ZielWs.Cells(zielRow, "U").Value = Gestern ' Datum von Gestern oder Freitag
                    ZielWs.Cells(zielRow, "V").Value = wsRohdaten.Cells(j, "D").Value ' Datum
                    ZielWs.Cells(zielRow, "W").Value = wsRohdaten.Cells(j, "E").Value ' Bemerkung

                    zielRow = zielRow + 1 ' Nächste Zeile vorbereiten
                End If
            Next j
        Else
            Debug.Print "Das Arbeitsblatt " & ZielBlattName & " existiert nicht."
        End If
    Next i

    Debug.Print "Datenübertragung abgeschlossen!"
    MsgBox "Datenübertragung abgeschlossen!", vbInformation
End Sub
