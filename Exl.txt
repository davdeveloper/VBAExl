Sub DatenImportierenUndVergleichen()
    ' Deklaration der Variablen für die Arbeitsmappen (Excel-Dateien) und Arbeitsblätter
    Dim sfWorkbook As Workbook
    Dim levelWorkbook As Workbook
    Dim zuweisungWorkbook As Workbook
    Dim sfWorksheet As Worksheet
    Dim levelWorksheet As Worksheet
    Dim zuweisungAktuellWorksheet As Worksheet
    Dim zuweisungLevelWorksheet As Worksheet
    
    ' Deklaration der Variablen für die letzte Zeile in den Arbeitsblättern
    Dim sfLastRow As Long
    Dim levelLastRow As Long
    Dim zuweisungLastRow As Long
    
    ' Öffne die SF.xlsx-Datei
    Set sfWorkbook = Workbooks.Open("Pfad_zur_SF.xlsx_Datei")
    Set sfWorksheet = sfWorkbook.Sheets(1) ' Annahme: Daten sind im ersten Arbeitsblatt
    
    ' Öffne die Level.xlsx-Datei
    Set levelWorkbook = Workbooks.Open(ThisWorkbook.Path & "\Level.xlsx")
    Set levelWorksheet = levelWorkbook.Sheets(1) ' Annahme: Daten sind im ersten Arbeitsblatt
    
    ' Aktuelle Arbeitsmappe, in der das Makro ausgeführt wird
    Set zuweisungWorkbook = ThisWorkbook
    
    ' Arbeitsblätter in der aktuellen Arbeitsmappe
    Set zuweisungLevelWorksheet = zuweisungWorkbook.Sheets("Zuweisung_Level")
    Set zuweisungAktuellWorksheet = zuweisungWorkbook.Sheets("Zuweisung_Aktuell")
    
    ' Bestimme die letzte Zeile in SF.xlsx
    sfLastRow = sfWorksheet.Cells(sfWorksheet.Rows.Count, "A").End(xlUp).Row
    
    ' Filtere nach "Lidl" in Spalte D in SF.xlsx
    sfWorksheet.Range("D:D").AutoFilter Field:=4, Criteria1:="Lidl"
    
    ' Kopiere die Vorgangsnummern aus Spalte A in "Zuweisung_Level"
    sfWorksheet.Range("A2:A" & sfLastRow).SpecialCells(xlCellTypeVisible).Copy _
        Destination:=zuweisungLevelWorksheet.Range("A1")
    
    ' Deaktiviere den Autofilter in SF.xlsx
    sfWorksheet.AutoFilterMode = False
    
    ' Bestimme die letzte Zeile in "Zuweisung_Level"
    zuweisungLastRow = zuweisungLevelWorksheet.Cells(zuweisungLevelWorksheet.Rows.Count, "A").End(xlUp).Row
    
    ' Bestimme die letzte Zeile in Level.xlsx
    levelLastRow = levelWorksheet.Cells(levelWorksheet.Rows.Count, "A").End(xlUp).Row
    
    ' Durchlaufe alle Vorgangsnummern in "Zuweisung_Level" und vergleiche sie mit "Level"
    Dim sfRange As Range
    Dim cell As Range
    Dim levelRange As Range
    
    Set sfRange = zuweisungLevelWorksheet.Range("A2:A" & zuweisungLastRow)
    Set levelRange = levelWorksheet.Range("A2:A" & levelLastRow)
    
    For Each cell In sfRange
        If Not IsError(Application.Match(cell.Value, levelRange, 0)) Then
            ' Wenn eine Übereinstimmung gefunden wurde, hole die entsprechenden Daten aus "Level"
            Dim foundRow As Long
            foundRow = Application.Match(cell.Value, levelRange, 0) + 1 ' Offset um 1, da Match die Zeilennummer relativ zu Range zurückgibt
            zuweisungAktuellWorksheet.Cells(cell.Row, 2).Value = levelWorksheet.Cells(foundRow, 3).Value ' Spalte C von "Level"
            zuweisungAktuellWorksheet.Cells(cell.Row, 3).Value = levelWorksheet.Cells(foundRow, 4).Value ' Spalte D von "Level"
        End If
    Next cell
    
    ' Schließe die SF.xlsx-Datei ohne zu speichern
    sfWorkbook.Close SaveChanges:=False
    
    ' Schließe die Level.xlsx-Datei ohne zu speichern
    levelWorkbook.Close SaveChanges:=False
    
    ' Zeige eine Meldung, dass der Vorgang abgeschlossen ist
    MsgBox "Daten wurden importiert, verglichen und ergänzt.", vbInformation
End Sub
